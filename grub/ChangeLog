1999-03-27  Gordon Matzigkeit  <gord@trick.fig.org>

	* grub/main.c (usage): Display defaults for stage2 options.

	* grub/asmstub.c [NO_REMAPPING_LIBC_FUNCTIONS]: Rename to
	WITHOUT_LIBC_STUBS.
	* grub/main.c: Likewise.
	* shared_src/shared.h: Likewise.

1999-03-27  OKUJI Yoshinori  <okuji@kuicr.kyoto-u.ac.jp>

	* grub/asmstub.c (set_attrib): Use inch and addch, instead of
	chgat, because chgat doesn't work as expected.

1999-03-26  OKUJI Yoshinori  <okuji@kuicr.kyoto-u.ac.jp>

	* grub/asmstub.c (grub_stage2) [HAVE_LIBCURSES]: Call nodelay.
	(checkkey) [HAVE_LIBCURSES]: If getting an input character, then
	ungetch it, because checkkey shouldn't modify the input queue.

	Use file descriptors instead of file pointers to support
	>4GB disks in Linux.

	* grub/asmstub.c (grub_stage2): Call close instead of fclose.
	(get_diskinfo): Call open instead of fopen.
	(biosdisk) [__linux__]: Use _llseek instead of lseek.
	(biosdisk): Call read instead of fread.

	Add options so that the user can specify the config file.

	* grub/Makefile.am (CPPFLAGS): Use -fwritable-strings, because
	grub assumes that all strings resides at the data section.

	* grub/main.c: Define NO_REMAPPING_LIBC_FUNCTIONS before including
	shared.h.
	(OPT_CONFIG_FILE): New macro.
	(OPT_INSTALL_PARTITION): Likewise.
	(OPT_BOOT_DRIVE): Likewise.
	(longopts): Add new options, config-file, install-partition and
	boot-drive.
	(usage): Add the documentation for them.
	(main): Add handling code for OPT_CONFIG_FILE, OPT_INSTALL_PARTITION
	and OPT_BOOT_DRIVE.

	* grub/asmstub.c: Define NO_REMAPPING_LIBC_FUNCTIONS before including
	shared.h.
	(config_file): Make it char * instead of char [].
	(getrtsecs): Return current time instead of 0xff.

	* shared_src/shared.h [NO_REMAPPING_LIBC_FUNCTIONS]: Don't define
	libc-API-compatible function names.
	(config_file): Change the prototype from char [] to char *.
	(grub_putchar): Renamed from putchar.

1999-03-25  OKUJI Yoshinori  <okuji@kuicr.kyoto-u.ac.jp>

	* char_io.c (get_cmdline): Call cl_setcpos even if lpos == llen,
	because ncurses won't update the cursor position.

	* grub/main.c (OPT_HOLD): New macro.
	(longopts): New option --hold.
	(usage): Add the documentation about --hold.
	(main): Set hold if --hold is specified. Wait until cleared.

1999-03-22  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/cmdline.c (enter_cmdline): Check the return value of
	set_device in the `root' command.

	* shared_src/char_io.c (memcheck): Special-case cur_part_desc and
	reenable memory checking.

1999-03-21  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/boot.c (load_image): Make sure we use the mapped
	address before actually writing data to memaddr.

	* shared_src/char_io.c (get_cmdline): Only zero-terminate if there
	were leading blanks.  This prevents accidental truncation of
	commands.

	* grub/asmstub.c (get_diskinfo): Cache device geometries as well
	as file handles.
	Use the Linux HDIO_GETGEO ioctl to make a better guess at hard
	disk geometries.

1999-03-16  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/shared.h (geometry_t): Delete typedef, until we
	actually use it.

1999-03-16  OKUJI Yoshinori  <okuji@kuicr.kyoto-u.ac.jp>

	* shared_src/asm.S (biosdisk): Use a structure for geometry
	instead of a integer.
	(get_diskinfo): Take a pointer to a geometry structure as the
	second argument, and fill a geometry in it. Return 1 if an error
	occurs, otherwise return 0.
	* shared_src/boot.c (bsd_boot): Compute BIOS geometries for BSD.
	* shared_src/cmdline.c (enter_cmdline): Declare dest_geom as
	struct geometry.
	* shared_src/disk_io.c (buf_geom): Declare as struct geometry.
	* shared_src/filesys.h (SECTORS): Deleted.
	(HEADS): Likewise.
	(CYLINDERS): Likewise.
	* shared_src/shared.h (BIOSDISK_FLAG_LBA_EXTENSION): New macro.
	(struct geometry): New structure.
	(buf_geom): Correct the prototype.
	(get_diskinfo): Likewise.
	(biosdisk): Likewise.

1999-03-15  Gordon Matzigkeit  <gord@trick.fig.org>

	* grub/asmstub.c (doit): Nested function to get a clean stack
	frame while in grub_stage2.
	Use different assembler magic.  From OKUJI Yoshinori.

1999-03-14  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/stage2.c (run_menu): Use A_REVERSE and A_NORMAL
	constants instead of magic numbers.

	* shared_src/shared.h (A_REVERSE): Renamed from ATTR_INVERSE for
	compatibility with curses.
	(A_NORMAL): Renamed from ATTR_NORMAL.

	* shared_src/cmdline.c (enter_cmdline): Change prompt to "grub> ".
	(enter_cmdline): Only abort the boot if we are in a script.

	* shared_src/stage2.c (run_menu): Change prompts to "grub edit> ".

	* shared_src/char_io.c (memcheck): Use RAW_ADDR to compute memory
	locations.
	(get_cmdline): Change the `goto next line' code to account for
	newlines deleting to end of line under curses.

	* Innumerable cleanups to fix warnings.  There are still too many
	typecasts in the wrong places (int variables used to hold
	pointers, then casted to a pointer type), but things look better.

	* configure.in (CPPFLAGS): Bump up GCC warnings to -Wall
	-Wmissing-prototypes -Wunused.

	* shared_src/shared.h: Delete stupid declarations, and totally
	rearrange for clarity.
	(inb, outb): Move to cmdline.c, since it's only used there.
	(print_possibilities, fsmax, fsys_table): Move definitions to
	disk_io.c.

	* grub/asmstub.c: Fill in more stubs.

1999-03-13  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/gunzip.c (border): Rename to bitorder, to resolve
	clash with curses.
	* shared_src/stage2.c (timeout): Rename to grub_timeout.

	* configure.in: Check for curses libraries for use with
	/sbin/grub.

	* shared_src/shared.h (KEY_DELETE): Rename to KEY_DC, for
	compatibility with curses.
	(KEY_INSERT): Rename to KEY_IC.
	(KEY_PGDN): Rename to KEY_NPAGE.
	(KEY_PGUP): Rename to KEY_PPAGE.

	* shared_src/asm.S (asm_getkey): Renamed to getkey.

	* shared_src/char_io.c (getkey): Delete, because it's useless.

	* shared_src/shared.h: Resolve name clashes with libc by renaming
	overlapping functions to have grub_ prefixes, then defining
	macros.

	* grub/asmstub.c (start_stage2): Make some assertions about our
	scratch memory area.

	* shared_src/shared.h (end): Delete declaration.
	(RAW_ADDR, RAW_SEG): Macros to redirect /sbin/grub memory requests
	through grub_scratch_mem.

	* grub/asmstub.c (get_mem_map): Implement, simulating 4MB
	contiguous memory.
	(get_code_end): Implement, simulating with a malloced area.
	grub/asmstub.c (start_stage2): Initialize grub_scratch_mem.

	* shared_src/asm.S (get_mem_map): Some BIOSes expect the high word
	of %eax to be zero.
	(get_code_end): Move this from common.c so that we can stub it out
	in the simulator.

	* debian/rules: Make sure info files end up in /usr/info, not
	/info.

1999-03-10  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/asm.S (biosdisk): Make LBA mode work correctly.  From
	OKUJI Yoshinori.
	Unconditionally define NO_INT13_FALLBACK until we release GRUB
	0.6.  This will help debug any problems with the LBA support until
	then.

1999-03-09  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/asm.S (biosdisk): Compute location of
	disk_address_packet correctly.  From OKUJI Yoshinori.

1999-03-08  Gordon Matzigkeit  <gord@trick.fig.org>

	* docs/grub.texi: New Texinfo documentation.

	* shared_src/disk_io.c (set_device): First stab at interpreting
	Mach-style partition naming.

	* shared_src/stage2.c (run_menu): Don't say it was a failure if
	enter_cmdline returns nonzero... just wait for a key.

	* shared_src/cmdline.c (enter_cmdline): Return nonzero, and avoid
	the fallback command if we did an install.

	* shared_src/asm.S (_start): New explicit symbol to supress
	warnings.

	* e2fs_stage1_5/Makefile.am (NO_FANCY_STUFF): Renamed to STAGE1_5,
	since that describes this conditional more accurately.
	* fat_stage1_5/Makefile.am: Likewise.
	* ffs_stage1_5/Makefile.am: Likewise.
	* shared_src/asm.S: Likewise.
	* shared_src/char_io.c: Likewise.
	* shared_src/common.c: Likewise.
	* shared_src/disk_io.c: Likewise.
	* shared_src/fsys_ext2fs.c: Likewise.
	* shared_src/fsys_ffs.c: Likewise.
	* shared_src/shared.h: Likewise.

1999-03-07  Gordon Matzigkeit  <gord@trick.fig.org>

	* configure.in (SHARED_SRC_RULES): Automatically generate
	Makefile dependencies for files in shared_src.
	e2fs_stage1_5/Makefile.am: Use them.
	fat_stage1_5/Makefile.am: Likewise.
	ffs_stage1_5/Makefile.am: Likewise.
	grub/Makefile.am: Likewise.
	stage2/Makefile.am: Likewise.
	stage2_debug/Makefile.am: Likewise.

	* shared_src/disk_inode.h: Fix typo: i_ic shouldn't be defined.

	* shared_src/fsys_ffs.c (block_map): Make static, since this
	function isn't used outside of its defining file.

	* shared_src/disk_io.c [NO_FANCY_STUFF]: Eliminate a whole bunch
	more functions from the stage1.5.  From OKUJI Yoshinori.
	* shared_src/fsys_ffs.c: Likewise.
	* shared_src/char_io.c: Likewise.

1999-03-05  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/char_io.c (getkey): Don't set BUF_DRIVE to -1.
	BUF_DRIVE has nothing at all to do with getkey.

	* shared_src/common.c (err_list): Change description of ERR_GEOM
	to be more informative.

	* Makefile.am (configure): Depend on debian/changelog.

	* configure.in (host_cpu): Make all fully i386-compatible CPUs be
	identified as i386.
	(AM_INIT_AUTOMAKE): Fetch values for PACKAGE and VERSION from
	debian/changelog, so that we only have one file to update.

	* shared_src/asm.S (get_diskinfo): Fix a few bit-twiddling bugs in
	the BIOS extension detection code.
	(biosdisk) [AWARD_INT13_EXTENSIONS]: Preliminary implementation
	of Award's encoding of cylinder bits 10 and 11.
	(biosdisk) [NO_INT13_FALLBACK]: If defined, don't use the standard
	disk interface if the extended interface fails.

	* configure.in: Make sure $(host_cpu) and $(host_vendor) are
	substituted into the Makefile.

	* e2fs_stage1_5/Makefile.am (pkgdatadir): Install files in
	$(datadir)/grub/$(host_cpu)-$(host_vendor).
	* fat_stage1_5/Makefile.am: Likewise.
	* ffs_stage1_5/Makefile.am: Likewise.
	* stage1/Makefile.am: Likewise.
	* stage2/Makefile.am: Likewise.
	* stage2_debug/Makefile.am: Likewise.

1999-03-03  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/asm.S (biosdisk): Use LBA mode if high nibble of
	GEOMETRY is nonzero.
	(get_diskinfo): Set high nibble of GEOMETRY (0xf0000000) to 1 if
	LBA mode is detected.

1999-03-02  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/disk_io.c (make_saved_active): Use BIOSDISK_READ and
	BIOSDISK_WRITE.

	* shared_src/cmdline.c (enter_cmdline): Use BIOSDISK_WRITE.

	* shared_src/shared.h (BIOSDISK_SUBFUNC_READ,
	BIOSDISK_SUBFUNC_WRITE): Delete constants.

	* shared_src/asm.S (biosdisk): Change subfunc argument to be
	read=0, write=1.

	* configure.in: Drop redundant AC_PROG_INSTALL.  From OKUJI
	Yoshinori.

1999-03-01  Gordon Matzigkeit  <gord@trick.fig.org>

	* debian/rules (binary-arch): Properly install README.debian.

	* acinclude.m4 (grub_OBJCOPY_ABSOLUTE): Don't forget to move the
	old binary out of the way before reentering the loop.
	(grub_ASM_ADDR32): Delete conftest files after running the test.

	* debian/rules (binary-arch): Remove empty /sbin directory until
	/sbin/grub is installed.  Use $(DESTDIR) instead of $(prefix) to
	install files.

	* shared_src/asm.S (version_string): Set the version string from
	the VERSION specified in configure.in.

	* Change all Makefiles into Makefile.ams.  Many major build
	environment changes to get Automake/Autoconf working nicely.

1999-02-28  Gordon Matzigkeit  <gord@trick.fig.org>

	* NEWS: Moved from docs/NEWS.

	* configure.in, acinclude.m4: New files for Autoconf.  From OKUJI
	Yoshinori.

	* AUTHORS, INSTALL: New files.

1999-02-24  Gordon Matzigkeit  <gord@trick.fig.org>

	* stage1/stage1.S (after_BPB): Do a hard disk probe first, so that
	we can work with IDE floppies (like the LS-120).

	* Run GNU Indent on */*.[ch].

1999-02-21  Gordon Matzigkeit  <gord@trick.fig.org>

	* debian: Add to the distribution, since we maintain the GRUB
	Debian package ourselves.

	* grub/asmstub.c: New file to implement stubbed assembly functions
	under Unix.

	* stage1/Makefile: Delete spurious dependencies on Makefile.
	* stage2/Makefile: Likewise.
	* stage2_debug/Makefile: Likewise.
	* grub/Makefile: Likewise.

	* shared_src/fsys_ext2fs.c (ext2fs_dir): Follow symbolic links
	rather than giving an error.

	* shared_src/common.c (err_list): Use labeled elements to
	associate messages with error codes.
	* shared_src/shared.h: Make error codes into an enumerated type.

	* shared_src/common.c (err_list): Add ERR_SYMLINK_LOOP.
	* shared_src/shared.h: Likewise.

	* shared_src/char_io.c (bcopy): Don't make any assumptions about
	the length of an unsigned long.

	* grub/Makefile: Treat CFLAGS, CPPFLAGS, LDFLAGS according to
	GNU standards.
	* stage2/Makefile: Likewise.
	* e2fs_stage1_5/Makefile: Likewise.
	* fat_stage1_5/Makefile: Likewise.
	* ffs_stage1_5/Makefile: Likewise.

1999-02-20  Gordon Matzigkeit  <gord@trick.fig.org>

	* docs/index.html: Rename to grub.html, so that we don't hide
	files in this directory from a web browser.

1999-02-15  Gordon Matzigkeit  <gord@trick.fig.org>

	* Makefile.end (PROGS): Add grub.

	* grub/main.c: New file.

	* grub/Makefile: New directory to contain the stage2 Unix program.

	* shared_src/cmdline.c: Use substring.
	* shared_src/fsys_ext2fs.c: Likewise.
	* shared_src/fsys_fat.c: Likewise.
	* shared_src/fsys_ffs.c: Likewise.
	* shared_src/stage2.c: Likewise.

	* shared_src/shared.h: Delete strcmp, declare substring.

	* shared_src/char_io.c (strcmp): Rename to `substring', because
	this function doesn't behave the same as libc's strcmp.

1999-02-14  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/shared.h: (addr32, data32): Delete definitions.

	* stage1/stage1.S: Modify to use GAS's new .code16 semantics.
	shared_src/asm.S: Likewise.

	* configure: Test to see if the `addr32' instruction is supported.
	Ian Lance Taylor says that GAS's interpretation of `.code16' has
	changed.  Older versions always generated 32-bit code, but
	implicitly inserted addr32 and data32 when .code16 was given.
	Newer versions generate 16-bit code, and require manual addr32 and
	data32 overrides.

	* shared_src/shared.h: Add some assertions to check that buffer
	addresses are properly defined.

1999-02-12  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/stage2.c (run_menu): Pause if we failed to boot both
	the default and fallback entries.

	* configure: Check to make sure that GAS actually honors .code16
	directives.

1999-02-02  Gordon Matzigkeit  <gord@trick.fig.org>

	* shared_src/asm.S: Fix typo that called interrupt 0xd (decimal
	13) instead of 0x13.

1999-01-31  Gordon Matzigkeit  <gord@trick.fig.org>

	* e2fs_stage1_5/Makefile: Avoid gratuitous dependencies on
	Makefile.
	* fat_stage1_5/Makefile: Likewise.
	* ffs_stage1_5/Makefile: Likewise.

	* Makefile.end (PROGS): Add e2fs_stage1_5, fat_stage1_5, and
	grubinst.
	(distclean): New GNU standard rule.

1998-10-23  Gordon Matzigkeit  <gord@trick.fig.org>

	* configure: Accept `--host' as a synonym for `--target', and
	accept a non-optional argument as the target name.  Join the
	prefix to the tool name with a hyphen.

	* shared_src/disk_io.c (print_fsys_type): Always print the
	partition type.

	* shared_src/stage2.c (run_menu): Check to make sure that the
	fallback entry is nonnegative.
	(run_menu): For consistency, use `e' rather than enter to edit the
	command entry.
